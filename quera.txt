SET NOCOUNT ON; DECLARE @input nvarchar(128) = N'Сертификат качества, Акт, Счет', @inputType nvarchar(8); DROP TABLE IF EXISTS #inputDocTypes; SELECT RTRIM(LTRIM(value)) as DocType INTO #inputDocTypes FROM STRING_SPLIT (@input, ',') SET @inputType = CASE WHEN (N'Сертификат качества' IN (SELECT DocType FROM #inputDocTypes) AND ( N'Акт' IN (SELECT DocType FROM #inputDocTypes) OR N'Счет' IN (SELECT DocType FROM #inputDocTypes)) ) THEN 'both' WHEN (N'Сертификат качества' NOT IN (SELECT DocType FROM #inputDocTypes) AND ( N'Акт' IN (SELECT DocType FROM #inputDocTypes) OR N'Счет' IN (SELECT DocType FROM #inputDocTypes)) ) THEN 'bill' WHEN (N'Сертификат качества' IN (SELECT DocType FROM #inputDocTypes) AND N'Акт' NOT IN (SELECT DocType FROM #inputDocTypes) AND N'Счет' NOT IN (SELECT DocType FROM #inputDocTypes) ) THEN 'cert' END DECLARE @AttrID nvarchar(128) = '', @AttrName nvarchar(255) = '', @CatName nvarchar(128) = '', @Selectsubquery nvarchar(max) = '', @Fieldsetsubquery nvarchar(max) = '', @i int = 0, @sql nvarchar(max) = ''; IF object_id('tempdb..#TempCat') is not null DROP TABLE #TempCat CREATE TABLE #TempCat (CategoryID int, CatName nvarchar(128), AttrID nvarchar(128), AttrName nvarchar(255), RankID int) INSERT INTO #TempCat(CategoryID, CatName, AttrID, AttrName, RankID) SELECT CatID as CategoryID, CatName, CAST(SUBSTRING(REPLACE(RegionName,CatID,''),7,7) as int) as AttrID, AttrName, DENSE_RANK() OVER (ORDER BY RegionName) as RankID FROM CatRegionMap WHERE CatID in (794859,768137) DECLARE AttrCursor CURSOR FOR SELECT RankID, AttrName, CatName FROM #TempCat; OPEN AttrCursor FETCH NEXT FROM AttrCursor INTO @AttrID, @AttrName, @CatName WHILE @@FETCH_STATUS = 0 BEGIN SET @Selectsubquery +=N', ['+CAST(@AttrID as nvarchar(128))+N'] as '''+@CatName+'_'+@AttrName+N''' ' IF @i>0 SET @Fieldsetsubquery += N',['+CAST(@AttrID as nvarchar(128))+N']' ELSE SET @Fieldsetsubquery += N'['+CAST(@AttrID as nvarchar(128))+N']' FETCH NEXT FROM AttrCursor INTO @AttrID, @AttrName, @CatName SET @i+=1 END CLOSE AttrCursor; DEALLOCATE AttrCursor; SET @sql = N' SELECT DataID' + @Selectsubquery + N' into #cat FROM ( SELECT AD.ID as DataID, T.RankID, COALESCE(CAST(ValInt as nvarchar(255)), CAST(ValReal as nvarchar(255)), CAST(ValDate as nvarchar(255)), CAST(ValStr as nvarchar(255)), CAST(ValLong as nvarchar(255))) as Val FROM LLAttrData AD inner join #TempCat T on T.AttrID=AD.AttrID and T.CategoryID=AD.DefID ) P PIVOT ( MAX(Val) FOR P.RankID IN (' + @Fieldsetsubquery + N') ) as Pvt SELECT COALESCE([Сертификат_Балансовая единица], [Счет/Акт_Балансовая единица]) AS BalanceUnit ,s.DocType ,d.Name AS DocumentName ,COALESCE([Сертификат_Номер документа сформированного в системе SAP], [Счет/Акт_Номер документа сформированного в системе SAP]) AS DocumentNumber ,COALESCE([Сертификат_Дата документа], [Счет/Акт_Дата документа]) AS DocumentDate ,CASE WHEN s.TransferState = ''error'' THEN N''Ошибка передачи'' WHEN s.Status = ''canceled'' THEN N''Сторнирован'' WHEN s.Status = ''obsolete'' THEN N''Устарел'' WHEN s.State = ''part-signed'' THEN N''Частично подписан'' WHEN s.State = ''signed'' THEN N''Подписан'' WHEN s.TransferState = ''pending'' THEN N''Ожидает передачи'' WHEN s.TransferState = ''locked'' THEN N''Ожидает подписания сертификата'' WHEN s.TransferState = ''delivered'' THEN N''На подписи'' END AS DocStatus ,s.DocumentID ,COUNT(*) over () as TotalRows FROM #cat c JOIN MIH_EDS_WF_SUP s ON c.DataID = s.DocWorkspaceID JOIN DTree d ON d.DataID = s.DocumentID WHERE s.DocType IN (SELECT * FROM STRING_SPLIT (N''Сертификат качества,Акт '', '','')) AND ( ( ('''+ @inputType + N''' = ''both'' ) AND ( [Счет/Акт_Номер документа сформированного в системе SAP] >= ''0090008690'' OR s.DocType = N''Сертификат качества'' ) ) OR( ('''+ @inputType + N''' = ''bill'' ) AND [Счет/Акт_Номер документа сформированного в системе SAP] >= ''0090008690'' ) ) AND ( ( ('''+ @inputType + N''' = ''both'' ) AND ( [Счет/Акт_Номер документа сформированного в системе SAP] <= ''0090008717'' OR s.DocType = N''Сертификат качества'' ) ) OR( ('''+ @inputType + N''' = ''bill'' ) AND [Счет/Акт_Номер документа сформированного в системе SAP] <= ''0090008717'' ) ) AND ( ( ('''+ @inputType + N''' = ''both'' ) AND ( [Сертификат_Номер документа сформированного в системе SAP] >= ''0000000201949000002001192'' OR s.DocType != N''Сертификат качества'' ) ) OR ('''+ @inputType + N''' = ''cert'' AND [Сертификат_Номер документа сформированного в системе SAP] >= ''0000000201949000002001192'' ) ) ' exec sp_executesql @sql 